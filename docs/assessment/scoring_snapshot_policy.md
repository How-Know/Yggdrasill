# 출석/과제 스냅샷 운영 정책 (v1)

## 1) 목적

- 출석 점수와 과제 점수를 안정적으로 추적하기 위한 스냅샷 기준을 정의한다.
- 레벨 입력 학생만 스냅샷 비교에 참여시키고, 미입력 학생은 현재 상태만 보여준다.
- 향후 예측 모델(고3 실제 등급 기반 확률화)로 확장 가능한 데이터 형태를 확보한다.

## 2) 현재 범위 / 제외 범위

### 포함

- 출석 점수 스냅샷
- 과제 점수 스냅샷
- 현재/예상/희망 축 기반 비교 표시 규칙

### 제외 (후순위)

- 문제(문항) 단위 세부 분석
- 문항 기반 예측 모델링/학습
- 총점 산출 자동 파이프라인

## 3) 스냅샷 참여 규칙

- 참여 기본 조건: `현재 등급` + `예상 등급`이 유효
- `희망 등급`은 비교축 강화용으로 저장(미입력이어도 참여 가능)
- 레벨 미입력 학생은 스냅샷 비교 대상에서 제외
  - UI 정책: 실시간 현재 상태만 노출, 비교/랭킹/백분위는 비노출

## 4) 주기 분리 권장안

### 4-1. 출석 점수

- 기본 주기: `학생-수업일 단위 1회 upsert`
  - 권장 트리거: 하원/수업종료 후 출석 상태가 안정화되는 시점
- 보조 주기: `주간 마감 스냅샷`(일요일 또는 월초)
- 규모 추정(80명, 주 2회): 약 `160건/주`

### 4-2. 과제 점수

- 기본 주기: `학생-일 단위 1회 upsert`
  - 그날 검사/완료 이벤트가 1건 이상 있으면 일일 집계 스냅샷 생성
- 보조 주기: `주간 마감 스냅샷`(출석과 동일)
- 규모 추정(80명, 주2회, 수업당 과제 4~5개):
  - 원시 이벤트: 약 `640~800건/주`
  - 스냅샷으로 압축 시: 학생-일 단위로 대폭 감소

### 4-3. 왜 분리해야 하는가

- 출석은 저빈도/상태 변동 적음 -> 수업일 단위가 자연스럽다.
- 과제는 고빈도/검사 반복 많음 -> 이벤트마다 저장하면 노이즈와 쓰기량이 커진다.
- 따라서 과제는 일 단위 집계 후 스냅샷이 비용/해석 모두 유리하다.

## 5) 비교 축(표시용)

- 현재 위치: 같은 학년 코호트 내 상대 위치
- 예상 위치: 고3 기준 코호트 내 상대 위치(현재는 수동 예상등급 기반)
- 희망등급 달성자 기준: 과거 달성자 집단의 같은 시점 분포 대비 현재 수준

## 6) 저장 설계 원칙

- 스냅샷 키는 idempotent upsert가 가능해야 한다.
  - 예: `(academy_id, student_id, metric, snapshot_date, snapshot_grain)`
- 원시 이벤트는 유지하고 스냅샷은 파생 데이터로 관리한다.
- 스냅샷은 계산식 버전(`formula_version`)을 포함한다.

## 7) 이벤트 훅 참고(구현 시)

- 출석 저장/수정 훅: `attendance_service.dart`의 출석 저장 경로
- 과제 검사/완료 훅: `homework_assignment_store.dart`, `homework_store.dart`의 검사/완료 경로
- 상세 훅 목록은 마이그레이션 로그 문서에서 관리한다.

## 8) 단계별 로드맵

1. 정책 문서 확정(본 문서)
2. 스냅샷 테이블/키 설계
3. 출석/과제 각각의 스냅샷 생성기 구현
4. UI 비교축 표시 연결
5. 문제 단위 분석/예측 모델링(최종 단계)
