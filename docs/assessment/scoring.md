# 점수화/집계 규칙

이 문서는 점수 체계를 "한 번에 완성"하지 않고, **마이그레이션처럼 누적 개선**하기 위한 기준서다.
각 점수 추가/수정은 반드시 변경 로그(마이그레이션 문서)와 함께 관리한다.

## 1) 운영 원칙

- 점수는 평가 그 자체가 아니라 **해석 보조 신호**다.
- 개입 가능 변수는 단계적으로 확장하되, **전체 조화(밸런스)**를 유지한다.
- 비개입 변수는 당장 총점 반영보다 **관찰/설명 축**으로 먼저 관리한다.
- 한 번에 여러 축을 크게 바꾸지 않고, **작은 단위 변경 + 검증**으로 진행한다.

## 2) 점수 스키마(공통)

새 지표를 추가할 때 아래 항목을 같이 정의한다.

- `id`: 시스템 내부 식별자(예: `attendance_score_v1`)
- `label`: UI 표기명(예: `출석 점수`)
- `bucket`: `non_intervention` | `intervention` | `performance`
- `scale`: 기본 `0~100`
- `direction`: 높을수록 좋은지/나쁜지 (`higher_is_better` 등)
- `formula_version`: 계산식 버전
- `weight`: 동일 버킷 내 가중치(총합 규칙 적용)
- `data_requirements`: 필요 데이터와 최소 건수
- `fallback_rule`: 데이터 부족 시 처리 방식

## 3) 비율/조화 가드레일

변경 시 아래 가드레일을 지킨다.

- **단일 지표 과대지배 방지**: 한 지표가 버킷 점수의 대부분을 결정하지 않도록 제한(권장 상한 35%).
- **결측 강건성**: 일부 지표가 비어도 전체가 붕괴하지 않게 `유효 가중치 재정규화` 적용.
- **신규 학생 보호**: 표본 적을 때 prior/k 스무딩 또는 최소 표본 규칙 사용.
- **시간 민감 지표**: 최근성 반영이 필요한 경우 반감기/감쇠 함수 명시.
- **비교 공정성**: 수업량·재원기간 편향을 줄이기 위해 비율형 집계 우선.

## 4) 집계 규칙(권장 기본)

### 4-1. 지표 점수

- 각 지표는 0~100으로 정규화해 노출한다.
- 계산 불가 시 `null` 대신 상태를 명시한다(예: `기록 부족`).

### 4-2. 버킷 점수

- 버킷 점수 = `Σ(지표점수 * 가중치) / Σ(유효 가중치)`
- 유효 가중치 = 현재 계산 가능한 지표의 가중치 합

### 4-3. 총점(향후)

- 총점은 후속 단계에서 도입.
- 도입 시에도 버킷별 비중/책임 범위를 문서로 먼저 확정 후 구현한다.

## 5) 마이그레이션 프로세스

점수 변경은 아래 순서로 진행한다.

1. 변경 제안 작성(무엇/왜/영향 범위)
2. 마이그레이션 문서 추가(`docs/assessment/scoring_migrations/`)
3. 코드 반영(서비스 계산식 + UI 표기)
4. 검증(편향/감쇠/렌더링/린트)
5. 필요 시 롤백 절차 문서화

## 6) 마이그레이션 문서 규격

파일명 규칙:

- `YYYYMMDD_NNN_<slug>.md`
- 예: `20260212_001_attendance_score_v1.md`

필수 섹션:

- 목표/배경
- 변경 전/후 규칙
- 파라미터(상수)와 근거
- 영향 범위(서비스, UI, 데이터)
- 검증 체크리스트
- 롤백 기준

## 7) 현재 적용 상태(2026-02-12)

- 개입 가능 변수:
  - `출석 점수 v1` 적용
  - 상세는 `scoring_migrations/20260212_001_attendance_score_v1.md` 참조
  - `출석 점수 v2(보강+순위)` 적용
  - 상세는 `scoring_migrations/20260212_002_attendance_makeup_rank_v2.md` 참조
- 총점/자동 반영 파이프라인:
  - 아직 미도입(2단계 이후)

## 8) 추가 원칙

- 비개입 변수도 장기적으로 수치화를 목표로 한다(객관적이지 않아도 됨).

## 9) 출석 점수 v2 규칙 요약(보강+순위)

### 9-1. 보강 반영

- 보강 카운트 기준:
  - `override_type=replace`, `reason=makeup`, `status=completed`
  - 기준 월: `replacement_class_datetime`의 연/월
- 월 수업 수 기준:
  - 동일 월의 유효 수업 이벤트(미래 planned 제외)
- 보강 비율:
  - `makeup_ratio = makeup_count / max(month_class_count, 1)`

### 9-2. 페널티 정책

- 월 보강 1회 이하는 점수 영향 없음
- 월 보강 2회 이상은 점진 페널티
- `makeup_ratio >= 0.5` 구간은 강한 페널티 구간으로 상향
- 점수는 항상 `0~100`으로 clamp

### 9-3. 재원생 순위 정책

- 코호트: 현재 재원생 목록(`students`)
- 순위: 출석 점수 내림차순
- 상위 퍼센트:
  - `top_percent = rank / cohort_size * 100`
- 동점:
  - 동일 점수(허용 오차 내) 공동 순위
